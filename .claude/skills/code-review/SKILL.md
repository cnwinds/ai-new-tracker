---
name: code-review
description: 对指定的 Git commit 进行全面的代码审查，包括获取 commit 信息和 diff、分析代码变更、生成调用链文档、评估接口变更、验证问题解决、检测潜在问题（资源泄露、空指针、死循环、性能问题等）、检查代码风格。使用场景：当用户提供 commit_id 需要审查代码变更时，或需要评估代码质量、安全性和可维护性时。
---

# Code Review Skill

对 Git commit 进行全面的代码审查，生成详细的审查报告。

## 工作流程

1. **获取 Commit 信息**
   - 使用 `git show <commit_id>` 获取提交描述和完整 diff
   - 解析提交消息、作者信息、修改文件列表

2. **代码变更分析**
   - 识别所有被修改、新增或删除的函数/方法、类、接口定义
   - 分析每个变更的上下文和影响范围

3. **调用链分析**
   - 对于每个被修改的函数，找出所有调用者和被调用者
   - 生成完整的调用关系图和调用链文档

4. **接口变更评估**
   - 检查函数签名、API 端点、数据库模型是否改变
   - 如果接口改变，找出所有使用点并检查是否都已更新
   - 评估向后兼容性

5. **问题解决验证**
   - 分析提交描述中的问题
   - 验证代码修改是否真正解决了问题

6. **潜在问题检测**
   - 资源泄露（文件句柄、数据库连接、网络连接等）
   - 空指针/空引用风险
   - 死循环风险
   - 性能问题（算法复杂度、系统运行效率、调用频率合理性，如渲染帧中的 update 函数调用开销较大的函数）
   - 是否是最优解

7. **代码风格检查**
   - 对比项目现有代码风格
   - 检查命名规范、格式化、注释风格等

8. **生成审查报告**
   - 使用报告模板生成完整的审查报告
   - 按照指定格式输出发现的问题

## 报告模板

使用 `assets/report-template.md` 作为报告模板。报告必须包含以下部分：

1. 基本信息（Commit ID、作者、提交消息等）
2. 变更摘要（修改文件列表、变更统计）
3. 代码变更分析（函数、类、接口）
4. 调用链分析（调用关系图、调用链文档）
5. 接口变更评估
6. 问题解决验证
7. 潜在问题检测
8. 代码风格检查
9. 总体评价和建议

## 问题输出格式

如果发现问题，必须按照以下格式提供反馈：

```
<问题分类>
<问题描述>
[问题代码文件名：代码行号]
[问题代码文件名：代码行号]
...
```

问题分类包括：
- 接口变更未同步
- 未解决问题
- 资源泄露
- 空指针风险
- 死循环风险
- 性能问题
- 非最优解
- 代码风格不一致

## 执行要求

1. **必须使用 git 命令获取 commit 信息**，不要依赖假设
2. **必须分析完整的 diff**，包括所有修改的文件
3. **调用链分析必须完整**，不能遗漏调用点
4. **接口变更检查必须全面**，找出所有使用点
5. **问题检测必须深入**，不能只看表面
6. **代码风格检查必须对比项目现有代码**
7. **如果未发现问题，也要明确说明"未发现问题"**
8. **所有反馈必须具体**，指出具体的文件、行号和问题

## 使用示例

用户输入：
```
请审查 commit abc123
```

执行步骤：
1. 运行 `git show abc123` 获取 commit 信息
2. 分析 diff 识别所有变更
3. 生成调用链文档
4. 评估接口变更
5. 检测潜在问题
6. 生成审查报告

## 报告输出

审查完成后，生成完整的 Markdown 格式审查报告，保存到工作目录或直接输出给用户。报告应使用 `assets/report-template.md` 作为模板，填充所有相关信息。
